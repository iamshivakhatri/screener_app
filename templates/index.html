<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Data Dashboard</title>
    <!-- Include Tailwind CSS from CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Include Tabulator CSS from CDN -->
    <link href="https://unpkg.com/tabulator-tables/dist/css/tabulator.min.css" rel="stylesheet">
    <link href="{{url_for('static', filename='css/output.css')}}" rel="stylesheet">

    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

</head>
<style>
 #gainers-table{
    width: 100%;
}
#active-table{
    width: 100%;
}

#news_table{
    width: 100%;
}

.chart-container {
    width: 100%;
    height: 90%; /* Adjust height as needed */
}


</style>
<body class="bg-gray-400 text-gray-100 font-sans antialiased">

  

    <main class=" p-2 flex h-screen">
        <!-- First Section: Takes 1/4 of the space -->
        <section class="w-1/4">
            <div>
                <!-- Gainers Table -->
                <div id="gainers-table" class="mb-2"></div>
            </div>
    
            <div>
                <!-- Active Stocks Table -->
                <div id="active-table" class="mb-2"></div>
            </div>
    
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg space-y-6 max-h-96 overflow-y-auto max-w-400" id="news_table">
                <h3 class="text-2xl font-semibold mb-4 text-gray-100" id="news_title">News</h3>
                <ul id="news-container" class="list-disc pl-5 text-gray-300">
                    <!-- News items will be inserted here -->
                </ul>
            </div>
        </section>
    
        <!-- Second Section: Takes 3/4 of the space -->
        <section class="w-3/4 grid grid-cols-2 grid-rows-2 gap-4 ml-2 mr-2">
            <h3>5 minute interval</h3>
            <div id="chart1" class="chart-container p-2">
                <!-- 5-minute interval chart -->
            </div>
            <div id="chart2" class="chart-container p-2">
                <h3>1 minute interval</h3>

                <!-- 1-minute interval chart -->
            </div>
            <div id="chart3" class="chart-container p-2">
                <h3>1 day interval</h3>

                <!-- 1-day interval chart -->
            </div>
            <div id="chart4" class="chart-container p-2">
                <h3>10 second interval</h3>
                <!-- 10-second interval chart -->
            </div>
        </section>
        
    </main>
    

    <!-- Include Tabulator JS from CDN -->
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables/dist/js/tabulator.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const gainersData = {{ gainers | tojson | safe }};
            const activeData = {{ active | tojson | safe }};
            
            console.log(gainersData);
            console.log(activeData);
    
            // Initialize Gainers table with hard-coded column names
            var gainersTable = new Tabulator("#gainers-table", {
                layout: "fitColumns",
                columns: [
                    { title: "Symbol",
                     field: "symbol",
                    
                    },
                    { title: "Name", field: "name" },
                    { title: "Change", field: "change" },
                    { title: "Price", field: "price" },
                    { title: "% C",
                     field: "changesPercentage" ,
                     formatter: function(cell, formatterParams, onRendered){
                            let row = cell.getRow();
                            let pc = cell.getValue();
                            row.getElement().style.color = "darkgreen";
                           
                            return pc;
                            
                        },
                    },
                    
                ],
               
                data: gainersData,
            });

            gainersTable.on("rowClick", function(e, row) {
                console.log("Row Clicked:", row.getData());
                get_news(row.getData().symbol);
            });


    
            // Initialize Active Stocks table
            var activeTable = new Tabulator("#active-table", {
                layout: "fitColumns",
                width: 400,
                columns: [
                    { title: "Symbol", field: "symbol" },
                    { title: "Name", field: "name" },
                    { title: "Price", field: "price"},
                    { title: "Change", field: "change" },
                    { title: "% C", field: "changesPercentage",
              
                     formatter: function(cell, formatterParams, onRendered){
                            let row = cell.getRow();
                            let pc = cell.getValue();
                            row.getElement().style.color = "darkgreen";
                           
                            return pc;
                            
                        },
                    },
                 
                ],
                data: activeData,
                
            });
            activeTable.on("rowClick", function(e, row) {
                console.log("Row Clicked:", row.getData().symbol);
                get_news(row.getData().symbol);
             });

        });

        async function get_news(ticker){
            const response = await fetch(`/news/${ticker}`);
            const data = await response.json();
            console.log("Fetched data:", data);

            const newsContainer = document.getElementById('news-container');
            newsContainer.innerHTML = ''; // Clear previous news

            const newsTitle = document.getElementById('news_title');
            newsContainer.innerHTML = '';
            newsTitle.innerHTML = `${ticker} News`;

            if (data.length === 0) {
                const listItem = document.createElement('li');
                listItem.classList.add('mb-4');
                listItem.textContent = "No news available";
                newsContainer.appendChild(listItem);
                return;
            }else{
                data.forEach(news_item => {
                console.log("Processing news item:", news_item);
                
                if (!news_item ) {
                    console.log("News item is incomplete or missing:", news_item);
                    
                    // If any required information is missing, create a placeholder item
                    const listItem = document.createElement('li');
                    listItem.classList.add('mb-4');
                    listItem.textContent = "News couldn't be retrieved";
                    newsContainer.appendChild(listItem);
                    return;
                }

                const listItem = document.createElement('li');
                listItem.classList.add('mb-4');

                const link = document.createElement('a');
                link.href = news_item.url;
                link.target = '_blank';
                link.classList.add('text-blue-400', 'hover:underline');
                link.textContent = news_item.title;

                const summary = document.createElement('p');
                summary.classList.add('mt-1');
                summary.textContent = news_item.summary;

                listItem.appendChild(link);
                listItem.appendChild(summary);
                newsContainer.appendChild(listItem);
                
                console.log("Appended news item:", news_item);
            });
            }

   
        }


    </script>
    <script>
        function createCandlestickChart(containerId, data) {
            const chart = LightweightCharts.createChart(document.getElementById(containerId), {
                width: document.getElementById(containerId).clientWidth,
                height: document.getElementById(containerId).clientHeight,
                layout: {
                    backgroundColor: '#ffffff',
                    textColor: '#000000',
                },
                grid: {
                    vertLines: {
                        color: '#e1e1e1',
                    },
                    horzLines: {
                        color: '#e1e1e1',
                    },
                },
            });
    
            const candlestickSeries = chart.addCandlestickSeries();
            candlestickSeries.setData(data);
    
            window.addEventListener('resize', () => {
                chart.resize(document.getElementById(containerId).clientWidth, document.getElementById(containerId).clientHeight);
            });
        }
    
        function convertToCandlestickData(rawData) {
            return rawData.map(item => ({
                time: Math.floor(item.date / 1000),
                open: item.open,
                high: item.high,
                low: item.low,
                close: item.close,
            }));
        }
    
        function loadDataAndCreateCharts() {
            // Fetching data for each interval and creating corresponding charts
            fetch('static/data.json')
                .then(response => response.json())
                .then(rawData => {
                    const candlestickData = convertToCandlestickData(rawData);
                    createCandlestickChart('chart1', candlestickData); // 1-Minute Chart
                })
                .catch(error => console.error('Error loading 1-minute data:', error));
    
            fetch('static/data-5min.json')
                .then(response => response.json())
                .then(rawData => {
                    const candlestickData = convertToCandlestickData(rawData);
                    createCandlestickChart('chart2', candlestickData); // 5-Minute Chart
                })
                .catch(error => console.error('Error loading 5-minute data:', error));
    
            fetch('static/data-15min.json')
                .then(response => response.json())
                .then(rawData => {
                    const candlestickData = convertToCandlestickData(rawData);
                    createCandlestickChart('chart3', candlestickData); // 15-Minute Chart
                })
                .catch(error => console.error('Error loading 15-minute data:', error));
    
            fetch('static/data-30min.json')
                .then(response => response.json())
                .then(rawData => {
                    const candlestickData = convertToCandlestickData(rawData);
                    createCandlestickChart('chart4', candlestickData); // 30-Minute Chart
                })
                .catch(error => console.error('Error loading 30-minute data:', error));
        }
    
        loadDataAndCreateCharts();
    </script>
    
    
    
   
    
</body>
</html>
